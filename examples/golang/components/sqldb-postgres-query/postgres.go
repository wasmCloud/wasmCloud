package main

import (
	"fmt"

	interfaces "github.com/wasmcloud/wasmcloud/examples/golang/components/sqldb-postgres-query/gen"
)

const CREATE_TABLE_QUERY = `
CREATE TABLE IF NOT EXISTS example (
	id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	description text NOT NULL,
	created_at timestamptz NOT NULL DEFAULT NOW()
);
`

// A basic insert query, using Postgres `RETURNING` syntax,
// which returns the contents of the row that was inserted
const INSERT_QUERY = `
INSERT INTO example (description) VALUES ($1) RETURNING *;
`

const SELECT_QUERY = `
SELECT * FROM example WHERE description = 'inserted example go row!';
`

// type aliases for more readable code
type PgValue = interfaces.WasmcloudPostgres0_1_1_draft_QueryPgValue
type RowEntry = interfaces.WasmcloudPostgres0_1_1_draft_TypesResultRowEntry

type Component struct{}

func init() {
	component := Component{}
	// Set the incoming handler struct to HttpServer
	interfaces.SetExportsWasmcloudExamplesInvoke(component)
}

func (c Component) Call() string {
	query := Query(CREATE_TABLE_QUERY, make([]PgValue, 0))
	if query.IsErr() {
		return fmt.Sprintf("ERROR: failed to create table: %v", query.UnwrapErr())
	}

	val := interfaces.WasmcloudPostgres0_1_1_draft_TypesPgValueText("inserted example go row!")
	insertResult := Query(INSERT_QUERY, []PgValue{val})
	if insertResult.IsErr() {
		return fmt.Sprintf("ERROR: failed to insert row: %v", insertResult.UnwrapErr())
	}

	selectResult := Query(SELECT_QUERY, make([]PgValue, 0))
	if selectResult.IsErr() {
		return fmt.Sprintf("ERROR: failed to select rows: %v", selectResult.UnwrapErr())
	}
	selectedRows := selectResult.Unwrap()
	if len(selectedRows) > 0 {
		firstRow := selectedRows[0]
		return fmt.Sprintf("SUCCESS: we selected a row! %v", firstRow)
	}
	return "ERROR: failed to retrieve inserted row"
}

type ResultRow = interfaces.WasmcloudPostgres0_1_1_draft_QueryResultRow
type QueryError = interfaces.WasmcloudPostgres0_1_1_draft_QueryQueryError

// Helper function to assist with readability in the example when querying the database
func Query(query string, params []PgValue) interfaces.Result[[]ResultRow, QueryError] {
	return interfaces.WasmcloudPostgres0_1_1_draft_QueryQuery(query, params)
}

//go:generate wit-bindgen-wrpc go --out-dir gen --package github.com/wasmCloud/wasmCloud/examples/go/providers/custom-template/bindings wit
//go:generate wit-bindgen tiny-go wit --out-dir=gen --gofmt
func main() {}
