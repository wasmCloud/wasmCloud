name: wasmcloud

on:
  pull_request:
  merge_group:
  workflow_dispatch:
    inputs:
      crate:
        type: choice
        description: crate to smart-release
        options:
          # Core crates
          - wasmcloud-component
          - wasmcloud-control-interface
          - wasmcloud-core
          - wasmcloud-host
          - wasmcloud-runtime
          - wasmcloud-tracing
          # SDK and utilities
          - wasmcloud-provider-sdk
          - wasmcloud-secrets-client
          - wasmcloud-secrets-types
          - wasmcloud-test-util
          - provider-archive
          - opentelemetry-nats
          - wascap
          # CLI
          - wash
          # Provider crates (also published to crates.io)
          - wasmcloud-provider-blobstore-azure
          - wasmcloud-provider-blobstore-fs
          - wasmcloud-provider-blobstore-nats
          - wasmcloud-provider-blobstore-s3
          - wasmcloud-provider-http-client
          - wasmcloud-provider-http-server
          - wasmcloud-provider-keyvalue-nats
          - wasmcloud-provider-keyvalue-redis
          - wasmcloud-provider-keyvalue-vault
          - wasmcloud-provider-messaging-kafka
          - wasmcloud-provider-messaging-nats
          - wasmcloud-provider-sqldb-postgres
      do-release:
        type: boolean
        description: Leave unchecked to create a pull request with changes for verification, then check to create a release directly with changes
      additional-args:
        type: string
        description: Advanced; Additional arguments to pass to `smart-release`
  push:
    branches:
      - main
    tags:
      - 'component-v[0-9].[0-9]+.[0-9]+'
      - 'component-v[0-9].[0-9]+.[0-9]+-*'
      - 'control-interface-v[0-9].[0-9]+.[0-9]+'
      - 'control-interface-v[0-9].[0-9]+.[0-9]+-*'
      - 'core-v[0-9].[0-9]+.[0-9]+'
      - 'core-v[0-9].[0-9]+.[0-9]+-*'
      - 'host-v[0-9].[0-9]+.[0-9]+'
      - 'host-v[0-9].[0-9]+.[0-9]+-*'
      - 'opentelemetry-nats-v[0-9].[0-9]+.[0-9]+'
      - 'opentelemetry-nats-v[0-9].[0-9]+.[0-9]+-*'
      - 'provider-archive-v[0-9].[0-9]+.[0-9]+'
      - 'provider-archive-v[0-9].[0-9]+.[0-9]+-*'
      - 'provider-blobstore-azure-v[0-9].[0-9]+.[0-9]+'
      - 'provider-blobstore-azure-v[0-9].[0-9]+.[0-9]+-*'
      - 'provider-blobstore-fs-v[0-9].[0-9]+.[0-9]+'
      - 'provider-blobstore-fs-v[0-9].[0-9]+.[0-9]+-*'
      - 'provider-blobstore-nats-v[0-9].[0-9]+.[0-9]+'
      - 'provider-blobstore-nats-v[0-9].[0-9]+.[0-9]+-*'
      - 'provider-blobstore-s3-v[0-9].[0-9]+.[0-9]+'
      - 'provider-blobstore-s3-v[0-9].[0-9]+.[0-9]+-*'
      - 'provider-http-client-v[0-9].[0-9]+.[0-9]+'
      - 'provider-http-client-v[0-9].[0-9]+.[0-9]+-*'
      - 'provider-http-server-v[0-9].[0-9]+.[0-9]+'
      - 'provider-http-server-v[0-9].[0-9]+.[0-9]+-*'
      - 'provider-keyvalue-nats-v[0-9].[0-9]+.[0-9]+'
      - 'provider-keyvalue-nats-v[0-9].[0-9]+.[0-9]+-*'
      - 'provider-keyvalue-redis-v[0-9].[0-9]+.[0-9]+'
      - 'provider-keyvalue-redis-v[0-9].[0-9]+.[0-9]+-*'
      - 'provider-keyvalue-vault-v[0-9].[0-9]+.[0-9]+'
      - 'provider-keyvalue-vault-v[0-9].[0-9]+.[0-9]+-*'
      - 'provider-messaging-kafka-v[0-9].[0-9]+.[0-9]+'
      - 'provider-messaging-kafka-v[0-9].[0-9]+.[0-9]+-*'
      - 'provider-messaging-nats-v[0-9].[0-9]+.[0-9]+'
      - 'provider-messaging-nats-v[0-9].[0-9]+.[0-9]+-*'
      - 'provider-sdk-v[0-9].[0-9]+.[0-9]+'
      - 'provider-sdk-v[0-9].[0-9]+.[0-9]+-*'
      - 'provider-sqldb-postgres-v[0-9].[0-9]+.[0-9]+'
      - 'provider-sqldb-postgres-v[0-9].[0-9]+.[0-9]+-*'
      - 'runtime-v[0-9].[0-9]+.[0-9]+'
      - 'runtime-v[0-9].[0-9]+.[0-9]+-*'
      - 'secrets-client-v[0-9].[0-9]+.[0-9]+'
      - 'secrets-client-v[0-9].[0-9]+.[0-9]+-*'
      - 'secrets-types-v[0-9].[0-9]+.[0-9]+'
      - 'secrets-types-v[0-9].[0-9]+.[0-9]+-*'
      - 'test-util-v[0-9].[0-9]+.[0-9]+'
      - 'test-util-v[0-9].[0-9]+.[0-9]+-*'
      - 'tracing-v[0-9].[0-9]+.[0-9]+'
      - 'tracing-v[0-9].[0-9]+.[0-9]+-*'
      - 'v[0-9].[0-9]+.[0-9]+'
      - 'v[0-9].[0-9]+.[0-9]+-*'
      - 'wascap-v[0-9].[0-9]+.[0-9]+'
      - 'wascap-v[0-9].[0-9]+.[0-9]+-*'
      - 'wash-v[0-9].[0-9]+.[0-9]+'
      - 'wash-v[0-9].[0-9]+.[0-9]+-*'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  meta:
    runs-on: ubuntu-latest
    outputs:
      wasmcloud_modified: ${{ steps.changes.outputs.wasmcloud }}
      providers_modified: ${{ steps.changes.outputs.providers }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: changes
        with:
          filters: |
            wasmcloud:
              - './.github/workflows/wasmcloud.yml'
              - './.github/workflows/build-bin.yml'
              - './.github/workflows/build-oci.yml'
              - './.config/nextest.toml'
              - 'Cargo.lock'
              - 'Cargo.toml'
              - 'rust-toolchain.toml'
              - 'crates/!(wash|provider-*)/**/*.{rs,toml,wit}'
              - 'src/**/*.{rs,toml,wit}'
              - 'tests/**/*.{rs,toml,wit}'
              - 'wit/**/*.wit'
            providers:
              - './.github/workflows/provider.yml'
              - './.github/workflows/wasmcloud.yml'
              - './.github/workflows/build-bin.yml'
              - 'Cargo.lock'
              - 'Cargo.toml'
              - 'crates/provider-*/*.{rs,toml,wit}'
              - 'rust-toolchain.toml'

  # Build wash binary for all platforms
  build-wash:
    needs: [meta]
    if: ${{ needs.meta.outputs.wasmcloud_modified == 'true' || startsWith(github.ref, 'refs/tags/wash-v') || startsWith(github.ref, 'refs/tags/provider-') }}
    uses: ./.github/workflows/build-bin.yml
    with:
      bin: wash
      build-windows-msvc: true

  # Build wasmcloud binary for all platforms
  build-wasmcloud:
    needs: [meta]
    if: ${{ needs.meta.outputs.wasmcloud_modified == 'true' || startsWith(github.ref, 'refs/tags/v') }}
    uses: ./.github/workflows/build-bin.yml
    with:
      bin: wasmcloud

  # Build provider binaries
  build-providers:
    needs: [meta]
    if: ${{ needs.meta.outputs.providers_modified == 'true' || startsWith(github.ref, 'refs/tags/provider-') }}
    strategy:
      fail-fast: false
      matrix:
        provider:
          - blobstore-azure
          - blobstore-fs
          - blobstore-nats
          - blobstore-s3
          - keyvalue-nats
          - keyvalue-redis
          - keyvalue-vault
          - http-client
          - http-server
          - messaging-kafka
          - messaging-nats
          - sqldb-postgres
    uses: ./.github/workflows/build-bin.yml
    with:
      bin: ${{ matrix.provider }}-provider
      crate: wasmcloud
      features: provider-${{ matrix.provider }}

  # Run cargo tests with nextest
  cargo-nextest:
    needs: [meta]
    if: ${{ needs.meta.outputs.wasmcloud_modified == 'true' || needs.meta.outputs.providers_modified == 'true' || startsWith(github.ref, 'refs/tags/') }}
    name: cargo nextest
    runs-on: ubuntu-latest-8-cores
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@b3b07ba8b418998c39fb20f53e8b695cdcc8de1b # master
        with:
          toolchain: stable

      - name: Install nextest
        uses: taiki-e/install-action@5c3e7b4b33e3543e3ffe25d6a6db08a90b06b0af # v2.52.7
        with:
          tool: nextest

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          shared-key: nextest-shared-cache

      - name: Run tests
        run: cargo nextest run --workspace --config-file ./.config/nextest.toml

  # Run cargo checks (fmt, clippy, audit, doctest)
  cargo-checks:
    needs: [meta]
    if: ${{ needs.meta.outputs.wasmcloud_modified == 'true' || needs.meta.outputs.providers_modified == 'true' || startsWith(github.ref, 'refs/tags/') }}
    strategy:
      fail-fast: false
      matrix:
        check:
          - name: fmt
            command: cargo fmt --all -- --check
          - name: clippy
            command: cargo clippy --workspace --all-targets -- -D warnings
          - name: audit
            command: cargo audit
          - name: doctest
            command: cargo test --doc --workspace
    name: cargo ${{ matrix.check.name }}
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@b3b07ba8b418998c39fb20f53e8b695cdcc8de1b # master
        with:
          toolchain: stable
          components: clippy, rustfmt

      - name: Install cargo-audit
        if: ${{ matrix.check.name == 'audit' }}
        uses: taiki-e/install-action@5c3e7b4b33e3543e3ffe25d6a6db08a90b06b0af # v2.52.7
        with:
          tool: cargo-audit

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          shared-key: cargo-checks-shared-cache

      - name: Run ${{ matrix.check.name }}
        run: ${{ matrix.check.command }}

  # Build documentation
  build-doc:
    needs: [meta]
    if: ${{ needs.meta.outputs.wasmcloud_modified == 'true' || startsWith(github.ref, 'refs/tags/') }}
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@b3b07ba8b418998c39fb20f53e8b695cdcc8de1b # master
        with:
          toolchain: stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          shared-key: cargo-doc-shared-cache

      - name: Build documentation
        run: cargo doc --workspace --no-deps
        env:
          RUSTDOCFLAGS: -D warnings

      - name: Prepare documentation
        run: |
          cp -R ./target/doc ./doc
          rm -f doc/.lock
          touch doc/.nojekyll
          cat <<EOF > doc/index.html
          <!DOCTYPE html>
          <meta charset="utf-8">
          <title>Redirecting to wasmcloud_host/index.html</title>
          <meta http-equiv="refresh" content="0; URL=wasmcloud_host/index.html">
          <link rel="canonical" href="https://${{ github.repository_owner }}.github.io/wasmCloud/wasmcloud_host/index.html">
          EOF

      - uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa # v3.0.1
        with:
          path: doc

  # Package and release providers
  providers:
    if: ${{ needs.meta.outputs.providers_modified == 'true' || startsWith(github.ref, 'refs/tags/provider-') }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: blobstore-azure
            subject: BLOBSTORE_AZURE_SUBJECT
            embed_wit: true
          - name: blobstore-fs
            subject: BLOBSTORE_FS_SUBJECT
            embed_wit: true
          - name: blobstore-nats
            subject: BLOBSTORE_NATS_SUBJECT
            embed_wit: true
          - name: blobstore-s3
            subject: BLOBSTORE_S3_SUBJECT
            embed_wit: true
          - name: keyvalue-nats
            subject: KEYVALUE_NATS_SUBJECT
            embed_wit: true
          - name: keyvalue-redis
            subject: KEYVALUE_REDIS_SUBJECT
            embed_wit: true
          - name: keyvalue-vault
            subject: KEYVALUE_VAULT_SUBJECT
            embed_wit: true
          - name: http-client
            subject: HTTP_CLIENT_SUBJECT
            embed_wit: false
          - name: http-server
            subject: HTTP_SERVER_SUBJECT
            embed_wit: false
          - name: messaging-kafka
            subject: MESSAGING_KAFKA_SUBJECT
            embed_wit: true
          - name: messaging-nats
            subject: MESSAGING_NATS_SUBJECT
            embed_wit: true
          - name: sqldb-postgres
            subject: SQLDB_POSTGRES_SUBJECT
            embed_wit: true
    needs:
      - meta
      - build-wash
      - build-providers
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/provider.yml
    with:
      name: ${{ matrix.name }}
      embed_wit: ${{ matrix.embed_wit }}
    secrets:
      issuer: ${{ secrets.WASMCLOUD_ACCOUNT_OFFICIAL }}
      subject: ${{ secrets[matrix.subject] }}

  # Deploy documentation to GitHub Pages
  deploy-doc:
    runs-on: ubuntu-24.04
    needs: build-doc
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
        id: deployment

  # Build and push wash OCI images
  oci-wash:
    needs:
      - build-wash
    if: ${{ startsWith(github.ref, 'refs/tags/wash-v') || github.ref == 'refs/heads/main' }}
    uses: ./.github/workflows/build-oci.yml
    permissions:
      contents: read
      packages: write
    with:
      bin: wash
      tag-prefix: 'wash-'
    secrets:
      DOCKERHUB_PUSH_USER: ${{ secrets.DOCKERHUB_PUSH_USER }}
      DOCKERHUB_PUSH_PASSWORD: ${{ secrets.DOCKERHUB_PUSH_PASSWORD }}

  # Build and push wasmcloud OCI images
  oci-wasmcloud:
    needs:
      - build-wasmcloud
    if: ${{ startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main' }}
    uses: ./.github/workflows/build-oci.yml
    permissions:
      contents: read
      packages: write
    with:
      bin: wasmcloud
    secrets:
      DOCKERHUB_PUSH_USER: ${{ secrets.DOCKERHUB_PUSH_USER }}
      DOCKERHUB_PUSH_PASSWORD: ${{ secrets.DOCKERHUB_PUSH_PASSWORD }}

  # Release wasmcloud binary
  release-wasmcloud:
    if: startsWith(github.ref, 'refs/tags/v')
    needs:
      - build-doc
      - build-wasmcloud
      - cargo-checks
      - cargo-nextest
      - oci-wasmcloud
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          path: artifacts
          pattern: wasmcloud-*

      - name: Prepare release artifacts
        run: |
          mkdir -p release
          for dir in ./artifacts/wasmcloud-*; do
            suffix="${dir#./artifacts/wasmcloud-}"
            bin_path="${dir}/bin/wasmcloud"
            if [[ -f "${dir}/bin/wasmcloud.exe" ]]; then
              bin_path="${dir}/bin/wasmcloud.exe"
              cp "${bin_path}" "release/wasmcloud-${suffix}.exe"
            else
              chmod +x "${bin_path}"
              cp "${bin_path}" "release/wasmcloud-${suffix}"
            fi
          done
          ls -la release/

      - uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631 # v2.2.2
        with:
          draft: true
          prerelease: true
          generate_release_notes: true
          files: ./release/*

  # Release wash CLI
  release-wash-cli:
    if: startsWith(github.ref, 'refs/tags/wash-v')
    needs:
      - build-doc
      - build-wash
      - cargo-checks
      - cargo-nextest
      - oci-wash
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          path: artifacts
          pattern: wash-*

      - name: Prepare release artifacts
        run: |
          mkdir -p release
          for dir in ./artifacts/wash-*; do
            suffix="${dir#./artifacts/wash-}"
            bin_path="${dir}/bin/wash"
            if [[ -f "${dir}/bin/wash.exe" ]]; then
              bin_path="${dir}/bin/wash.exe"
              cp "${bin_path}" "release/wash-${suffix}.exe"
            else
              chmod +x "${bin_path}"
              cp "${bin_path}" "release/wash-${suffix}"
            fi
          done
          ls -la release/

      - uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631 # v2.2.2
        with:
          draft: true
          prerelease: true
          generate_release_notes: true
          files: ./release/*

      - name: Extract version
        run: |
          VERSION=$(echo "${GITHUB_REF##*/}" | sed -e 's/wash-v//')
          echo "wash_version=$VERSION" >> $GITHUB_ENV

      - name: Release homebrew
        uses: peter-evans/repository-dispatch@ff45666b9427631e3450c54a1bcbee4d9ff4d7c0 # v3.0.0
        with:
          token: ${{ secrets.HOMEBREW_CHOCOLATEY_DISPATCH_TOKEN }}
          repository: wasmCloud/homebrew-wasmcloud
          event-type: brew-formula-update
          client-payload: |
            {"tag_prefix": "wash", "tag_version": "${{ env.wash_version }}"}

      - name: Release chocolatey
        uses: peter-evans/repository-dispatch@ff45666b9427631e3450c54a1bcbee4d9ff4d7c0 # v3.0.0
        with:
          token: ${{ secrets.HOMEBREW_CHOCOLATEY_DISPATCH_TOKEN }}
          repository: wasmCloud/chocolatey-wash
          event-type: choco-formula-update
          client-payload: |
            {"wash_version": "${{ env.wash_version }}"}

  # Build and publish Linux packages (deb/rpm)
  nfpm:
    if: startsWith(github.ref, 'refs/tags/wash-v')
    env:
      REF: ${{ github.ref }}
      PACKAGECLOUD_TOKEN: ${{ secrets.PACKAGECLOUD_API_TOKEN }}
    needs:
      - cargo-checks
      - cargo-nextest
      - build-wash
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install NFPM
        uses: taiki-e/install-action@5c3e7b4b33e3543e3ffe25d6a6db08a90b06b0af # v2.52.7
        with:
          tool: nfpm

      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: wash-linux-aarch64
          path: ./crates/wash/aarch64

      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: wash-linux-amd64
          path: ./crates/wash/x86_64

      - name: Make wash executable
        working-directory: ./crates/wash
        run: |
          chmod +x ./aarch64/bin/wash
          chmod +x ./x86_64/bin/wash

      - name: Build deb and rpm
        working-directory: ./crates/wash
        run: |
          export VERSION=$(echo $REF| cut -d- -f3 | tr -d "v")
          nfpm pkg --packager deb -f build/nfpm.amd64.yaml
          nfpm pkg --packager deb -f build/nfpm.arm64.yaml
          nfpm pkg --packager rpm -f build/nfpm.amd64.yaml
          nfpm pkg --packager rpm -f build/nfpm.arm64.yaml

      - name: Push deb packages
        working-directory: ./crates/wash
        run: |
          debs=(35 203 206 207 210 215 219 220 221 233 235 237 261 266 278 284)
          for distro_version in "${debs[@]}"; do
            curl -F "package[distro_version_id]=${distro_version}" -F "package[package_file]=@$(ls wash_*_amd64.deb)" https://$PACKAGECLOUD_TOKEN:@packagecloud.io/api/v1/repos/wasmcloud/core/packages.json;
            curl -F "package[distro_version_id]=${distro_version}" -F "package[package_file]=@$(ls wash_*_arm64.deb)" https://$PACKAGECLOUD_TOKEN:@packagecloud.io/api/v1/repos/wasmcloud/core/packages.json;
          done

      - name: Push rpm packages
        working-directory: ./crates/wash
        run: |
          rpms=(194 204 209 216 226 231 236 239 240 244 260 273 279 283 302)
          for distro_version in "${rpms[@]}"; do
            curl -F "package[distro_version_id]=${distro_version}" -F "package[package_file]=@$(ls wash-*.aarch64.rpm)" https://$PACKAGECLOUD_TOKEN:@packagecloud.io/api/v1/repos/wasmcloud/core/packages.json;
            curl -F "package[distro_version_id]=${distro_version}" -F "package[package_file]=@$(ls wash-*.x86_64.rpm)" https://$PACKAGECLOUD_TOKEN:@packagecloud.io/api/v1/repos/wasmcloud/core/packages.json;
          done

  # Publish crate to crates.io based on tag
  publish-crate:
    name: Publish crate to crates.io
    # Only run on crate tags, not binary-only tags (v* handled by release-wasmcloud)
    if: |
      startsWith(github.ref, 'refs/tags/') &&
      !startsWith(github.ref, 'refs/tags/v')
    needs: cargo-checks
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@b3b07ba8b418998c39fb20f53e8b695cdcc8de1b # master
        with:
          toolchain: stable

      - name: Determine crate from tag
        id: crate
        run: |
          tag="${GITHUB_REF_NAME}"

          # Extract crate name (everything before -vX.Y.Z)
          # Examples: core-v0.21.0 -> core, provider-blobstore-fs-v0.12.0 -> provider-blobstore-fs
          crate=$(echo "$tag" | sed -E 's/-v[0-9]+\.[0-9]+\.[0-9]+.*$//')

          # Check if crate directory exists
          if [[ -d "crates/${crate}" ]]; then
            echo "crate=${crate}" >> "$GITHUB_OUTPUT"
            echo "Publishing crate: ${crate}"
          else
            echo "crate=" >> "$GITHUB_OUTPUT"
            echo "No crate directory for tag: ${tag}"
          fi

          # Extract version for logging
          version="${tag#${crate}-v}"
          echo "version=${version}" >> "$GITHUB_OUTPUT"

          # Detect pre-release
          if [[ "${version}" == *"-"* ]]; then
            echo "prerelease=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish to crates.io
        if: steps.crate.outputs.crate != ''
        continue-on-error: ${{ github.repository_owner != 'wasmCloud' }}
        run: cargo publish --token ${{ secrets.CRATES_PUBLISH_TOKEN }}
        working-directory: ./crates/${{ steps.crate.outputs.crate }}

  # Check crate publishability on PRs
  check-publish:
    name: Check crate publishability
    if: github.event_name == 'pull_request'
    needs: cargo-checks
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@b3b07ba8b418998c39fb20f53e8b695cdcc8de1b # master
        with:
          toolchain: stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          shared-key: check-publish-shared-cache

      - name: Check all crates can publish
        run: |
          for crate_dir in crates/*/; do
            crate=$(basename "$crate_dir")
            # Skip non-publishable crates
            if grep -q 'publish = false' "${crate_dir}/Cargo.toml" 2>/dev/null; then
              echo "Skipping ${crate} (publish = false)"
              continue
            fi
            echo "Checking ${crate}..."
            if ! cargo publish --dry-run -p "$(grep -m1 '^name = ' "${crate_dir}/Cargo.toml" | sed 's/name = "\(.*\)"/\1/')" 2>&1; then
              echo "::warning::${crate} failed dry-run publish check (may be due to unpublished workspace deps)"
            fi
          done

  # Smart release workflow
  smart-release:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Install cmake for smart-release
        run: sudo apt update && sudo apt install cmake -y

      - run: rustup show

      - name: Install smart-release
        env:
          RUSTFLAGS: ''
        run: cargo install cargo-smart-release --git https://github.com/brooksmtownsend/cargo-smart-release --branch feat/update-workspace-dependencies

      - name: Dry run release
        if: ${{ !inputs.do-release }}
        run: |
          git config --global user.email "automation@wasmcloud.com"
          git config --global user.name "wasmCloud automation"
          cargo smart-release --update-crates-index --no-publish --execute --no-changelog-preview --no-push ${{ inputs.additional-args }} ${{ inputs.crate }} --allow-dirty

      - name: Create Pull Request
        if: ${{ !inputs.do-release }}
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f # v7.0.5
        with:
          branch: release-${{ inputs.crate }}
          signoff: true
          committer: wasmCloud Automation <automation@wasmcloud.com>
          title: Release ${{ inputs.crate }}
          commit-message: 'release(${{ inputs.crate }}): release and update CHANGELOG'

      - name: Release
        if: ${{ inputs.do-release }}
        env:
          GH_TOKEN: ${{ github.token }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_PUBLISH_TOKEN }}
        run: |
          git config --global user.email "automation@wasmcloud.com"
          git config --global user.name "wasmCloud automation"
          cargo smart-release --update-crates-index --execute --no-changelog-preview --no-changelog ${{ inputs.additional-args }} ${{ inputs.crate }}

  # Final status check
  wasmcloud_successful_checks:
    needs:
      - meta
      - build-providers
      - build-wash
      - build-wasmcloud
      - cargo-checks
      - cargo-nextest
      - build-doc
      - providers
      - deploy-doc
      - oci-wash
      - oci-wasmcloud
      - check-publish
      - publish-crate
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Results
        run: |
          echo 'needs.build-providers.result: ${{ needs.build-providers.result }}'
          echo 'needs.build-wash.result: ${{ needs.build-wash.result }}'
          echo 'needs.build-wasmcloud.result: ${{ needs.build-wasmcloud.result }}'
          echo 'needs.cargo-checks.result: ${{ needs.cargo-checks.result }}'
          echo 'needs.cargo-nextest.result: ${{ needs.cargo-nextest.result }}'
          echo 'needs.build-doc.result: ${{ needs.build-doc.result }}'
          echo 'needs.providers.result: ${{ needs.providers.result }}'
          echo 'needs.deploy-doc.result: ${{ needs.deploy-doc.result }}'
          echo 'needs.oci-wash.result: ${{ needs.oci-wash.result }}'
          echo 'needs.oci-wasmcloud.result: ${{ needs.oci-wasmcloud.result }}'
          echo 'needs.check-publish.result: ${{ needs.check-publish.result }}'
          echo 'needs.publish-crate.result: ${{ needs.publish-crate.result }}'

      - name: Verify jobs
        if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')
        run: exit 1
