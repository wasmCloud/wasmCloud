name: check

on:
  pull_request:
  push:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SEGMENT_DOWNLOAD_TIMEOUT_MINS: 1 # abort caching attempt if it's slow

jobs:
  cargo-clippy:
    name: cargo clippy
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v3
    - run: sudo mkdir -p /nix
    - run: sudo chown $(whoami) /nix
    - uses: actions/cache@v3
      with:
        path: /nix
        key: nix
    - uses: nixbuild/nix-quick-install-action@v22
      with:
        nix_conf: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ github.token }}
          substituters = https://cache.nixos.org https://cache.garnix.io
          trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g=
    - uses: cachix/cachix-action@v12
      continue-on-error: true
      with:
        name: wasmcloud
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    - run: nix build -L .#checks.x86_64-linux.clippy

  cargo-doc:
    name: cargo doc
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v3
    - run: sudo mkdir -p /nix
    - run: sudo chown $(whoami) /nix
    - uses: actions/cache@v3
      with:
        path: /nix
        key: nix
    - uses: nixbuild/nix-quick-install-action@v22
      with:
        nix_conf: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ github.token }}
          substituters = https://cache.nixos.org https://cache.garnix.io
          trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g=
    - uses: cachix/cachix-action@v12
      continue-on-error: true
      with:
        name: wasmcloud
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    - run: nix build -L .#checks.x86_64-linux.doc

  cargo-fmt:
    name: cargo fmt
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v3
    - run: sudo mkdir -p /nix
    - run: sudo chown $(whoami) /nix
    - uses: actions/cache@v3
      with:
        path: /nix
        key: nix
    - uses: nixbuild/nix-quick-install-action@v22
      with:
        nix_conf: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ github.token }}
          substituters = https://cache.nixos.org https://cache.garnix.io
          trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g=
    - uses: cachix/cachix-action@v12
      continue-on-error: true
      with:
        name: wasmcloud
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    - run: nix build -L .#checks.x86_64-linux.fmt

  cargo-nextest:
    name: cargo nextest
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v3
    - run: sudo mkdir -p /nix
    - run: sudo chown $(whoami) /nix
    - uses: actions/cache@v3
      with:
        path: /nix
        key: nix
    - uses: nixbuild/nix-quick-install-action@v22
      with:
        nix_conf: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ github.token }}
          substituters = https://cache.nixos.org https://cache.garnix.io
          trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g=
    - uses: cachix/cachix-action@v12
      continue-on-error: true
      with:
        name: wasmcloud
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    - run: nix build -L .#checks.x86_64-linux.nextest
