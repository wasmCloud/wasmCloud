name: secrets-nats-kv

on:
  merge_group:
  push:
    branches: [main]
    tags:
      - 'secrets-nats-kv-v[0-9].[0-9]+.[0-9]+'
      - 'secrets-nats-kv-v[0-9].[0-9]+.[0-9]+-*'
  pull_request:
    branches: [main]
    paths:
      - .github/workflows/secrets-nats-kv.yml
      - Cargo.lock
      - Cargo.toml
      - crates/secrets-nats-kv/**
      - crates/secrets-client/**
      - crates/secrets-types/**

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  integration_tests:
    name: Integration Tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - run: rustup show
      - uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          shared-key: 'ubuntu-24.04-shared-cache'
      - name: Launch integration test services
        uses: sudo-bot/action-docker-compose@ef4c4da08a9673f93d4eb8a5da1e942bf24a37ea # v1.0.0
        with:
          cli-args: '-f ./crates/secrets-nats-kv/tools/docker-compose.yml up --detach'
      - name: Install nextest
        uses: taiki-e/install-action@5c3e7b4b33e3543e3ffe25d6a6db08a90b06b0af # v2.52.7
        with:
          tool: nextest
      - name: Run integration tests
        run: make test-integration-ci
        working-directory: ./crates/secrets-nats-kv

  release-crates:
    if: ${{ startsWith(github.ref, 'refs/tags/secrets-nats-kv-v') }}
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: cargo publish
        working-directory: ./crates/secrets-nats-kv
        run: cargo publish --token ${{ secrets.CRATES_PUBLISH_TOKEN }}

  # Build secrets-nats-kv binary for all platforms
  build:
    if: ${{ startsWith(github.ref, 'refs/tags/secrets-nats-kv-v') }}
    uses: ./.github/workflows/build-bin.yml
    with:
      bin: secrets-nats-kv

  release:
    if: ${{ startsWith(github.ref, 'refs/tags/secrets-nats-kv-v') }}
    needs: [build]
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Extract tag context
        id: ctx
        run: |
          sha_short=$(git rev-parse --short HEAD)
          echo "sha_short=${sha_short}" >> "$GITHUB_OUTPUT"

          version=$(cargo metadata --manifest-path "./crates/secrets-nats-kv/Cargo.toml" --no-deps --format-version 1 | jq -r '.packages[] | select(.name == "secrets-nats-kv") | .version')
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          if [[ $version == *"-"* ]]; then
            echo "prerelease=true" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: secrets-nats-kv-*
          merge-multiple: true
          path: artifacts

      - name: Prepare release artifacts
        run: |
          mkdir -p release
          for dir in artifacts/secrets-nats-kv-*; do
            if [[ -d "$dir" ]]; then
              suffix="${dir#artifacts/secrets-nats-kv-}"
              if [[ -f "${dir}/bin/secrets-nats-kv.exe" ]]; then
                cp "${dir}/bin/secrets-nats-kv.exe" "release/secrets-nats-kv-${suffix}.exe"
              else
                cp "${dir}/bin/secrets-nats-kv" "release/secrets-nats-kv-${suffix}"
                chmod +x "release/secrets-nats-kv-${suffix}"
              fi
            fi
          done
          # Copy linux-amd64 as the default linux binary
          if [[ -f release/secrets-nats-kv-linux-amd64 ]]; then
            cp release/secrets-nats-kv-linux-amd64 release/secrets-nats-kv-linux
          fi
          if [[ -f release/secrets-nats-kv-linux-aarch64 ]]; then
            cp release/secrets-nats-kv-linux-aarch64 release/secrets-nats-kv-linux-arm64
          fi
          ls -la release/

      - name: Release
        uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631 # v2.2.2
        with:
          draft: true
          prerelease: ${{ steps.ctx.outputs.prerelease != '' }}
          generate_release_notes: true
          files: |
            ./release/*

  # Build and push OCI images
  image-build:
    if: ${{ startsWith(github.ref, 'refs/tags/secrets-nats-kv-v') }}
    needs: [build]
    uses: ./.github/workflows/build-oci.yml
    permissions:
      contents: read
      packages: write
    with:
      bin: secrets-nats-kv
      tag-prefix: 'secrets-nats-kv-'
    secrets:
      DOCKERHUB_PUSH_USER: ${{ secrets.DOCKERHUB_PUSH_USER }}
      DOCKERHUB_PUSH_PASSWORD: ${{ secrets.DOCKERHUB_PUSH_PASSWORD }}
