name: install Nix

inputs:
  cachixAuthToken:
    description: auth token for https://app.cachix.org/organization/wasmcloud/cache/wasmcloud

env:
  SEGMENT_DOWNLOAD_TIMEOUT_MINS: 1 # abort caching attempt if it's slow

runs:
  using: composite
  steps:
  - run: sudo mkdir -p /nix
    if: ${{ runner.os == 'Linux' }}
    shell: bash
  - run: sudo chown $(whoami) /nix
    if: ${{ runner.os == 'Linux' }}
    shell: bash
  - uses: actions/cache@v3
    if: ${{ runner.os == 'Linux' }}
    with:
      path: /nix
      key: nix
  - uses: nixbuild/nix-quick-install-action@v22
    with:
      nix_conf: |
        experimental-features = nix-command flakes
        access-tokens = github.com=${{ github.token }}
        substituters = https://cache.nixos.org https://cache.garnix.io
        trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g=
  - uses: cachix/cachix-action@v12
    continue-on-error: true
    with:
      name: wasmcloud
      authToken: '${{ inputs.cachixAuthToken }}'
