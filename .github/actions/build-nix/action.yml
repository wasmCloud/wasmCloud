name: build via Nix

inputs:
  package:
    description: package specification to build
    required: true

runs:
  using: composite
  steps:
  - uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
    id: cache
    with:
      path: ${{ runner.temp }}/nix-store-${{ inputs.package }}
      key: ${{ inputs.package }}-${{ github.sha }}
      restore-keys: |
        ${{ inputs.package }}-

  - run: nix copy --no-check-sigs --all --from "file://${{ runner.temp }}/nix-store-${{ inputs.package }}"
    continue-on-error: true
    shell: bash
  - run: rm -rf "${{ runner.temp }}/nix-store-${{ inputs.package }}"
    shell: bash
  - run: nix build --fallback -L '.#${{ inputs.package }}'
    shell: bash
  - run: nix run --fallback -L --inputs-from . 'nixpkgs-unstable#coreutils' -- --coreutils-prog=cp -RLv ./result '${{ inputs.package }}'
    shell: bash
  - uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
    with:
      name: ${{ inputs.package }}
      path: ${{ inputs.package }}
  - run: nix copy --to "file://${{ runner.temp }}/nix-store-${{ inputs.package }}" '.#${{ inputs.package }}'
    shell: bash
  - uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
    with:
      name: nix-store-${{ inputs.package }}
      path: ${{ runner.temp }}/nix-store-${{ inputs.package }}
