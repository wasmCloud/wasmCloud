name: build via Nix

inputs:
  package:
    description: package specification to build
    required: true

runs:
  using: composite
  steps:
  - uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb
    id: cache
    with:
      path: ${{ runner.temp }}/nix-store-${{ inputs.package }}
      key: ${{ inputs.package }}-${{ github.sha }}
      restore-keys: |
        ${{ inputs.package }}-

  - run: nix copy --no-check-sigs --all --from "file://${{ runner.temp }}/nix-store-${{ inputs.package }}"
    continue-on-error: true
    shell: bash
  - run: rm -rf "${{ runner.temp }}/nix-store-${{ inputs.package }}"
    shell: bash
  - run: nix build --fallback -L '.#${{ inputs.package }}'
    shell: bash
  - run: nix run --fallback -L --inputs-from . 'nixpkgs-unstable#coreutils' -- --coreutils-prog=cp -RLv ./result '${{ inputs.package }}'
    shell: bash
  - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
    with:
      name: ${{ inputs.package }}
      path: ${{ inputs.package }}
  - run: nix copy --to "file://${{ runner.temp }}/nix-store-${{ inputs.package }}" '.#${{ inputs.package }}'
    shell: bash
  - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
    with:
      name: nix-store-${{ inputs.package }}
      path: ${{ runner.temp }}/nix-store-${{ inputs.package }}
