name: build PAR

inputs:
  name:
    description: provider name
    required: true
  capability:
    description: provider capability
    required: true
  subject:
    description: subject key
    required: true
  issuer:
    description: issuer key
    required: true

runs:
  using: composite
  steps:
  - uses: actions/download-artifact@v4
    with:
      path: artifacts

  - run: chmod +x "./artifacts/wasmcloud-aarch64-apple-darwin/bin/${{ inputs.name }}"
    shell: bash

  - run: chmod +x "./artifacts/wasmcloud-aarch64-unknown-linux-musl/bin/${{ inputs.name }}"
    shell: bash

  - run: chmod +x "./artifacts/wasmcloud-x86_64-apple-darwin/bin/${{ inputs.name }}"
    shell: bash

  - run: chmod +x "./artifacts/wasmcloud-x86_64-pc-windows-msvc/bin/${{ inputs.name }}.exe"
    shell: bash

  - run: chmod +x "./artifacts/wasmcloud-x86_64-unknown-linux-musl/bin/${{ inputs.name }}"
    shell: bash

  - run: chmod +x "./artifacts/wasmcloud-x86_64-unknown-linux-musl/bin/wash"
    shell: bash

  - run: |
      ./artifacts/wasmcloud-x86_64-unknown-linux-musl/bin/wash par create \
            --binary "./artifacts/wasmcloud-x86_64-unknown-linux-musl/bin/${{ inputs.name }}" \
            --capid "${{ inputs.capability }}" \
            --compress \
            --destination "${{ inputs.name }}.par.gz" \
            --name "${{ inputs.name }}" \
            --vendor wasmcloud \
            --version $(cargo metadata --manifest-path "./crates/provider-${{ inputs.name }}/Cargo.toml" --no-deps --format-version 1 | jq -r '.packages[] | select(.name == "wasmcloud-provider-${{ inputs.name }}") | .version')
    # TODO: Set env once configured
    #env:
      #WASH_ISSUER_KEY: ${{ inputs.issuer }}
      #WASH_SUBJECT_KEY: ${{ inputs.subject }}
    shell: bash

  - run: ./artifacts/wasmcloud-x86_64-unknown-linux-musl/bin/wash par insert --arch aarch64-linux  --binary "./artifacts/wasmcloud-aarch64-unknown-linux-musl/bin/${{ inputs.name }}" "${{ inputs.name }}.par.gz"
    shell: bash

  - run: ./artifacts/wasmcloud-x86_64-unknown-linux-musl/bin/wash par insert --arch aarch64-macos  --binary "./artifacts/wasmcloud-aarch64-apple-darwin/bin/${{ inputs.name }}" "${{ inputs.name }}.par.gz"
    shell: bash

  - run: ./artifacts/wasmcloud-x86_64-unknown-linux-musl/bin/wash par insert --arch x86_64-macos   --binary "./artifacts/wasmcloud-x86_64-apple-darwin/bin/${{ inputs.name }}" "${{ inputs.name }}.par.gz"
    shell: bash

  - run: ./artifacts/wasmcloud-x86_64-unknown-linux-musl/bin/wash par insert --arch x86_64-windows --binary "./artifacts/wasmcloud-x86_64-pc-windows-msvc/bin/${{ inputs.name }}.exe" "${{ inputs.name }}.par.gz"
    shell: bash

  - uses: actions/upload-artifact@v4
    with:
      name: ${{ inputs.name }}.par.gz
      path: ${{ inputs.name }}.par.gz
