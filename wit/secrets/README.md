# 🔐 `wasmcloud:secrets` WIT interface

This folder contains [WIT][wit] definitions for `wasmcloud:secrets`, an interface for interacting with [wasmCloud secrets][docs--secrets] from [WebAssembly components][docs-components] and [providers][docs-providers].

[wit]: https://github.com/WebAssembly/component-model/blob/main/design/mvp/WIT.md
[docs-components]: https://wasmcloud.com/docs/concepts/components
[docs-providers]: https://wasmcloud.com/docs/concepts/providers
[docs-secrets]: https://wasmcloud.com/docs/concepts/secrets

## 👟 Using this WIT interface

While `wasmcloud:secrets` is best used from the [wasmCloud][wasmcloud] ecosystem, this WIT contract can be used by any ecosystem project that fulfills the relevant WIT interfaces.

Primarily the relevant WIT interfaces in the `wasmcloud:secrets` package are *exported* by compliant secrets providers, and *imported* by components and/or providers that want to use them.

[wasmcloud]: https://wasmcloud.com/docs/intro

### 🏗️ Building WebAssembly components

These definitions are meant to be used while *creating* WebAssembly components, with whatever language toolchain is available to you.

| Language   | Toolchain                            |
|------------|--------------------------------------|
| Javascript | [`jco`][jco]  |
| Rust       | [`cargo-component`][cargo-component] |
| Rust       | [`wit-bindgen`][wit-bindgen-rust]    |
| Python     | [`componentize-py`][compnentize-py]  |
| Golang     | [`wit-bindgen`][wit-bindgen-go]      |

Depending on which language and toolchain you use, the specifics differ, but you should end up with a project that contains a `wit` folder.

[cargo-component]: https://github.com/bytecodealliance/cargo-component
[compnentize-py]: https://github.com/bytecodealliance/componentize-py
[jco]: https://github.com/bytecodealliance/jco
[wit-bindgen-go]: https://github.com/bytecodealliance/wit-bindgen?tab=readme-ov-file#guest-tinygo
[wit-bindgen-rust]: https://github.com/bytecodealliance/wit-bindgen

### ⬇️ Downloading this WIT

While ecosystem tooling for pulling and using WIT-manifest-only components develops, the easiest way to get started is to use [`wit-deps`][wit-deps], a dependency manager for WIT files.

In your project, include the following `wit/deps.toml`:

```yaml
secrets = "https://github.com/wasmCloud/wasmCloud/releases/download/wit-wasmcloud-secrets-v0.1.0-draft/wit-wasmcloud-secrets-0.1.0.tar.gz"
```

From your project root (the folder above `wit/`), you should be able to run `wit-deps`:

```console
wit-deps
```

This will populate a `wit/deps` folder and create `wit/deps.lock`.

[wit-deps]: https://github.com/bytecodealliance/wit-deps

### 🚀 Using interfaces in the `wasmcloud:secrets` WIT package

Using interfaces in the `wasmcloud:secrets` WIT package from your language of choice depends primarily on your language, toolchain, and the WebAssembly runtime you're using -- here are some examples for reference.

#### Guest: Rust

If using the Rust ecosystem with `wit-bindgen`, you might have a WIT `world` that looks like the following:

```wit
package wasmcloud:examples;

/// Invoke a component and receive string output. Similar to wasi:cli/command.run, without args
///
/// This enables the component to be used with `wash call`
interface invoke {
    /// Invoke a component
    call: func() -> string;
}

world component {
  import wasmcloud:secrets/store@0.1.0-draft;
  import wasmcloud:secrets/reveal@0.1.0-draft;
  export invoke;
}
```

To build a WebAssembly component that satisfies that `world`, you might write code that looks like this:

```rust
wit_bindgen::generate!({ generate_all });

// NOTE: the imports below is generated by wit_bindgen::generate, due to the
// WIT definition(s) specified in `wit`
use wasmcloud::secrets;
use wasmcloud::secrets::reveal::SecretValue;

// NOTE: Imagine that the `exec` interface is an exported interface with one
// function with the signature `call: func() -> string`
use exports::wasmcloud::examples::invoke::Guest;

/// Basic WebAssembly component that checks the length of secrets
///
/// Implementation of the `wasmcloud:examples/invoke` interface that we defined in WIT
/// will hang off of this struct.
struct SecretLenChecker;

const SECRET_KEY: &str = "secret-key";

impl Guest for SecretLenChecker {
    fn call() -> String {
        // Retrieve a secret
        let secret = match secrets::store::get(SECRET_KEY.into()) {
            Ok(s) => s,
            Err(err) => return format!("ERROR: failed to retreive secret [{SECRET_KEY}]: {err}"),
        };
        // Reveal the contents of the secret
        match secrets::reveal::reveal(&secret) {
            SecretValue::String(s) if s.len() > 24 => format!("SUCCESS: Your secret is very long!"),
            SecretValue::String(s) if s.len() > 12 => {
                format!("SUCCESS: Your secret is reasonably long!")
            }
            SecretValue::String(_) => format!("FAILURE: your secret is too short!"),
            SecretValue::Bytes(_) => format!("ERROR: your secret is the wrong type"),
        }
    }
}

export!(SecretLenChecker);
```

For the code above to work inside a component, you must deploy:

- The [wasmCloud host][docs-host]
- A compliant secrets provider (ex. [NATS KV Secrets backend][secrets-nats-kv])
- The component above, compiled with [`wash`][docs-wash]

See [wasmCloud documentation on how Secrets work](https://wasmcloud.com/docs/concepts/secrets#how-secrets-work-in-wasmcloud) for more information.

[docs-host]: https://wasmcloud.com/docs/concepts/hosts
[docs-wash]: https://wasmcloud.com/docs/ecosystem/wash/
[secrets-nats-kv]: https://github.com/wasmCloud/wasmCloud/tree/main/crates/secrets-nats-kv
