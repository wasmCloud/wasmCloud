# 🌐 `wasmcloud:websocket` WIT interface

This folder contains [WIT][wit] definitions for `wasmcloud:websocket`, an interface for establishing and managing WebSocket client connections from [WebAssembly components][docs-components] and [providers][docs-providers].

[wit]: https://github.com/WebAssembly/component-model/blob/main/design/mvp/WIT.md
[docs-components]: https://wasmcloud.com/docs/concepts/components
[docs-providers]: https://wasmcloud.com/docs/concepts/providers

## 👟 Using this WIT interface

While `wasmcloud:websocket` is best used from the [wasmCloud][wasmcloud] ecosystem, this WIT contract can be used by any ecosystem project that fulfills the relevant WIT interfaces.

The `wasmcloud:websocket` package provides two interfaces:
- **`types`**: Common types used by the client interface
- **`client`**: WebSocket client functionality for connecting to servers

These interfaces are *exported* by compliant WebSocket providers, and *imported* by components and/or providers that want to use them.

[wasmcloud]: https://wasmcloud.com/docs/intro

### 🏗️ Building WebAssembly components

These definitions are meant to be used while *creating* WebAssembly components, with whatever language toolchain is available to you.

| Language   | Toolchain                            |
|------------|--------------------------------------|
| Javascript | [`jco`][jco]  |
| Rust       | [`cargo-component`][cargo-component] |
| Rust       | [`wit-bindgen`][wit-bindgen-rust]    |
| Python     | [`componentize-py`][compnentize-py]  |
| Golang     | [`wit-bindgen`][wit-bindgen-go]      |

Depending on which language and toolchain you use, the specifics differ, but you should end up with a project that contains a `wit` folder.

[cargo-component]: https://github.com/bytecodealliance/cargo-component
[compnentize-py]: https://github.com/bytecodealliance/componentize-py
[jco]: https://github.com/bytecodealliance/jco
[wit-bindgen-go]: https://github.com/bytecodealliance/wit-bindgen?tab=readme-ov-file#guest-tinygo
[wit-bindgen-rust]: https://github.com/bytecodealliance/wit-bindgen

### ⬇️ Downloading this WIT

While ecosystem tooling for pulling and using WIT-manifest-only components develops, the easiest way to get started is to use [`wit-deps`][wit-deps], a dependency manager for WIT files.

In your project, include the following `wit/deps.toml`:

```yaml
websocket = "https://github.com/wasmCloud/wasmCloud/releases/download/wit-wasmcloud-websocket-v0.1.0-draft/wit-wasmcloud-websocket-0.1.0-draft.tar.gz"
```

From your project root (the folder above `wit/`), you should be able to run `wit-deps`:

```console
wit-deps
```

This will populate a `wit/deps` folder and create `wit/deps.lock`.

[wit-deps]: https://github.com/bytecodealliance/wit-deps

### 🚀 Using interfaces in the `wasmcloud:websocket` WIT package

Using interfaces in the `wasmcloud:websocket` WIT package from your language of choice depends primarily on your language, toolchain, and the WebAssembly runtime you're using -- here are some examples for reference.

#### Guest: Rust - WebSocket Client

If using the Rust ecosystem with `wit-bindgen` for WebSocket client functionality, you might have a WIT `world` that looks like the following:

```wit
package wasmcloud:examples;

/// Invoke a component and receive string output. Similar to wasi:cli/command.run, without args
///
/// This enables the component to be used with `wash call`
interface invoke {
    /// Invoke a component
    call: func() -> string;
}

world websocket-client {
  import wasmcloud:websocket/client@0.1.0-draft;
  export invoke;
}
```

To build a WebAssembly component that satisfies that `world`, you might write code that looks like this:

```rust
wit_bindgen::generate!({ generate_all });

// NOTE: the imports below is generated by wit_bindgen::generate, due to the
// WIT definition(s) specified in `wit`
use wasmcloud::websocket::client::{
    connect, ClientConfig, WebsocketHeaders
};
use wasmcloud::websocket::types::Message;

// NOTE: Imagine that the `invoke` interface is an exported interface with one
function with the signature `call: func() -> string`
use exports::wasmcloud::examples::invoke::Guest;

/// Basic WebAssembly component that connects to a WebSocket server
struct WebSocketClient;

impl Guest for WebSocketClient {
    fn call() -> String {
        // Create a WebSocket connection configuration
        let config = ClientConfig {
            url: "ws://echo.websocket.org".to_string(),
            subprotocols: Some(vec!["chat".to_string()]),
            headers: Some(vec![
                WebsocketHeaders {
                    name: "User-Agent".to_string(),
                    value: "wasmCloud-Component/1.0".to_string(),
                }
            ]),
            timeout_ms: Some(5000),
            max_message_size: Some(1024 * 1024), // 1MB
            enable_keepalive: Some(true),
            keepalive_interval_ms: Some(30000),
        };

        // Connect to WebSocket server
        match connect(config) {
            Ok(connection) => {
                // Send a text message
                let message = Message::Text("Hello, WebSocket!".to_string());
                match connection.send(message) {
                    Ok(_) => {
                        // Try to receive a response
                        match connection.receive() {
                            Ok(Some(Message::Text(response))) => {
                                format!("SUCCESS: Received response: {}", response)
                            }
                            Ok(Some(_)) => "SUCCESS: Received non-text message".to_string(),
                            Ok(None) => "SUCCESS: No message received".to_string(),
                            Err(err) => format!("ERROR: Failed to receive message: {:?}", err),
                        }
                    }
                    Err(err) => format!("ERROR: Failed to send message: {:?}", err),
                }
            }
            Err(err) => format!("ERROR: Failed to connect: {:?}", err),
        }
    }
}

export!(WebSocketClient);
```



For the code above to work inside a component, you must deploy:

- The [wasmCloud host][docs-host]
- A compliant WebSocket provider (such as a wasmCloud-native WebSocket provider)
- The component above, compiled with [`wash`][docs-wash]

See [wasmCloud documentation on how Components work](https://wasmcloud.com/docs/concepts/components) for more information.

[docs-host]: https://wasmcloud.com/docs/concepts/hosts
[docs-wash]: https://wasmcloud.com/docs/ecosystem/wash/

## 🔧 WebSocket Features

The `wasmcloud:websocket` interface provides WebSocket client functionality:

### Common Types (`types`)

- **Error Handling**: Comprehensive `websocket-error` enum for all WebSocket operations
- **Connection States**: `connection-state` enum representing connection lifecycle
- **Message Types**: `message` variant supporting text, binary, ping, pong, and close frames
- **Headers**: Structured header support for handshake customization

### Client Interface (`client`)

- **Connection Management**: Establish and manage connections to WebSocket servers
- **Configuration**: Flexible `client-config` with subprotocols, headers, timeouts, and keep-alive
- **Message Operations**: Send and receive messages with comprehensive error handling
- **State Monitoring**: Real-time connection state tracking
- **Resource Management**: Proper connection lifecycle management

### Key Capabilities

- **Full-duplex Communication**: Send and receive messages simultaneously
- **Protocol Compliance**: Complete WebSocket protocol support including ping/pong frames
- **Security**: Support for secure WebSocket connections (wss://)
- **Customization**: Custom headers, subprotocol negotiation
- **Performance**: Configurable message sizes, timeouts, and keep-alive
- **Monitoring**: Connection state tracking

## 📋 Interface Reference

### Types Interface

**Error Types:**
- `websocket-error`: Comprehensive error enum including:
  - `connection-failed`: Network connection issues
  - `invalid-url`: Malformed WebSocket URL
  - `protocol-error`: WebSocket protocol violations
  - `connection-closed`: Unexpected connection closure
  - `authentication-failed`: Authentication/authorization errors
  - `timeout`: Operation timeout
  - `invalid-message`: Message format/encoding errors
  - `io-error`: Generic I/O errors

**Connection Types:**
- `connection-state`: Connection lifecycle states (connecting, open, closing, closed)
- `message`: Message variants (text, binary, ping, pong, close)
- `close-info`: Close frame information with code and reason
- `websocket-headers`: Header structure for handshake customization

### Client Interface

**Configuration:**
- `client-config`: Connection configuration with URL, subprotocols, headers, timeouts, keep-alive

**Resource:**
- `connection`: Client connection resource with send, receive, close, get-state, get-url, get-subprotocol operations

**Functions:**
- `connect(config: client-config)`: Establish connection to WebSocket server 