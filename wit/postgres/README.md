# ðŸ˜ `wasmcloud:postgres` WIT interface

This folder contains [WIT][wit] definitions for `wasmcloud:postgres`, an interface for interacting with the [Postgres database system][postgres] from WebAssembly.

[wit]: https://github.com/WebAssembly/component-model/blob/main/design/mvp/WIT.md
[postgres]: https://postgresql.org

## ðŸ‘Ÿ Using this WIT interface

While `wasmcloud:postgres` is best used from the [wasmCloud][wasmcloud] ecosystem (i.e. with the wasmCloud `sqldb-postgres` provider), this WIT contract can be used by any ecosystem project that supports WIT interfaces and fulfilling WIT contracts (whether locally, or in a distributed fashion as wasmCloud does).

[wasmcloud]: https://wasmcloud.com/docs/intro

### ðŸ—ï¸ Building WebAssembly components

These definitions are meant to be used while *creating* WebAssembly components, with whatever language toolchain is available to you.

| Language   | Toolchain                            |
|------------|--------------------------------------|
| Javascript | [`jco`][jco]  |
| Rust       | [`cargo-component`][cargo-component] |
| Rust       | [`wit-bindgen`][wit-bindgen-rust]    |
| Python     | [`componentize-py`][compnentize-py]  |
| Golang     | [`wit-bindgen`][wit-bindgen-go]      |

Depending on which language and toolchain you use, the specifics differ, but you should end up with a project that contains a `wit` folder.

[cargo-component]: https://github.com/bytecodealliance/cargo-component
[compnentize-py]: https://github.com/bytecodealliance/componentize-py
[jco]: https://github.com/bytecodealliance/jco
[wit-bindgen-go]: https://github.com/bytecodealliance/wit-bindgen?tab=readme-ov-file#guest-tinygo
[wit-bindgen-rust]: https://github.com/bytecodealliance/wit-bindgen

### â¬‡ï¸ Downloading this WIT

While ecosystem tooling for pulling and using WIT-manifest-only components develops, the easiest way to get started is to use [`wit-deps`][wit-deps], a dependency manager for WIT files.

In your project, include the following `wit/deps.toml`:

```yaml
postgres = "https://github.com/wasmCloud/wasmCloud/releases/download/wit-wasmcloud-postgres-v0.1.0-draft/wit-wasmcloud-postgres-0.1.0-draft.tar.gz"
```

From your project root (the folder above `wit/`), you should be able to run `wit-deps`:

```console
wit-deps
```

This will populate a `wit/deps` folder and create `wit/deps.lock`.

[wit-deps]: https://github.com/bytecodealliance/wit-deps

### ðŸš€ Using the WIT interfaces

Using the WIT interfaces from your language of choice depends primarily on your language, toolchain, and the WebAssembly runtime you're using -- here are some examples for reference.

#### Guest: Rust

If using the Rust ecosystem with `wit-bindgen`, you might have a WIT `world` that looks like the following:

```wit
package wasmcloud:examples;

/// Invoke a component and receive string output. Similar to wasi:cli/command.run, without args
///
/// This enables the component to be used with `wash call`
interface invoke {
    /// Invoke a component
    call: func() -> string;
}

world component {
  import wasmcloud:postgres/query@0.1.0-draft;
  export invoke;
}
```

To build a WebAssembly component that satisfies that `world`, you might write code that looks like this:

```rust
wit_bindgen::generate!();

// NOTE: the imports below is generated by wit_bindgen::generate, due to the
// WIT definition(s) specified in `wit`
use wasmcloud::postgres::query::{query, PgValue};

// NOTE: Imagine that the `exec` interface is an exported interface with one
// function with the signature `call: func() -> string`
use exports::wasmcloud::examples::invoke::Guest;

// Implementation of the `exec` interface we're exporting goes here
struct QueryRunner;

impl Guest for QueryRunner {
    fn call() -> String {
        // Perform a query
        match query(
            "SELECT * FROM users WHERE email = $1",
            &[PgValue::Text(format!("some-text-input!"))],
        ) {
            // query completed successfully
            Ok(rows) => ...,
            // query failed
            Err(e) => ...,
        }
    }
}

export!(QueryRunner);
```
